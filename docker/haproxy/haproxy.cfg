global
    daemon
    log stdout local0
    stats timeout 30s

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    retries 3
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# HAProxy Statistics
listen stats
    bind *:8080
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-node
    stats admin if TRUE

# Main PostgreSQL service with enhanced repmgr failover support
# Routes based on connection type - write to active master
listen postgres-write
    bind *:3000
    mode tcp
    option pgsql-check user ramos
    balance first
    default-server inter 1s fall 2 rise 2 on-error mark-down
    
    # Enhanced health check for faster failover detection
    timeout check 2s
    
    # Master server (primary for write operations)
    server postgres-master postgres-master:5432 check weight 100 maxconn 100
    # Slave server (backup, automatically promoted on master failure)
    server postgres-slave postgres-slave:5432 check weight 100 backup maxconn 100

# PostgreSQL Read (Load balanced for read operations)
listen postgres-read
    bind *:3001
    mode tcp
    option pgsql-check user ramos
    balance roundrobin
    default-server inter 2s fall 2 rise 2 on-error mark-down
    timeout check 2s
    
    # Both servers available for read operations
    server postgres-master postgres-master:5432 check weight 50 maxconn 50
    server postgres-slave postgres-slave:5432 check weight 100 maxconn 100

# Health check endpoint for monitoring
listen health-check
    bind *:8090
    mode http
    monitor-uri /health
    option httpchk GET /health
    stats enable
    stats uri /status
