global
    daemon
    log stdout local0
    stats timeout 30s

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    retries 3
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# HAProxy Statistics
listen stats
    bind *:8080
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-node
    stats admin if TRUE

# Main PostgreSQL service (MMM VIP simulation)
# Routes based on connection type - write to master, read can go to slave
listen postgres-mmm
    bind *:3000
    mode tcp
    option pgsql-check user ramos
    balance source
    default-server inter 3s fall 3 rise 2 on-error mark-down

    # Master server (primary for all operations)
    server postgres-master postgres-master:5432 check weight 100
    # Slave server (backup only, promoted if master fails)
    server postgres-slave postgres-slave:5432 check weight 0 backup

# PostgreSQL Read (Load balanced for read operations)
listen postgres-read
    bind *:3001
    mode tcp
    option pgsql-check user ramos
    balance roundrobin
    default-server inter 3s fall 3 rise 2 on-error mark-down
    server postgres-master postgres-master:5432 check weight 50
    server postgres-slave postgres-slave:5432 check weight 100
